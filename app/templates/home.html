{% extends 'layout.html' %}
{% block page_content %}
<div class="max-w-2xl mx-auto mt-6 sm:mt-10 p-4 sm:p-6 bg-slate-100 dark:bg-slate-800 shadow-xl rounded-lg">
  {% if session.user_id %} 
    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
      <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-0 text-center text-slate-800 dark:text-slate-100">
        Last Played on Plex
      </h2>
    </div>

    {% if plex_event %}
      <div class="bg-slate-100 dark:bg-slate-800 shadow-xl rounded-lg p-4 sm:p-6 flex flex-col sm:flex-row items-start gap-4 sm:gap-6 mb-6">
        {% if plex_event.poster_url %}
          <img class="w-24 sm:w-32 h-36 sm:h-48 object-cover rounded-md border border-slate-300 dark:border-slate-700 shadow-sm" src="{{ url_for('main.image_proxy', url=plex_event.poster_url) }}" alt="{{ plex_event.title }} poster">
        {% else %}
          {# Optionally, display a placeholder if no poster_url is available #}
          <!-- <div class="w-24 sm:w-32 h-36 sm:h-48 bg-slate-200 dark:bg-slate-700 rounded-md flex items-center justify-center">
            <span class="text-slate-500 dark:text-slate-400 text-xs">No Poster</span>
          </div> -->
        {% endif %}
        <div class="flex-1">
          {# Determine main title based on media type #}
          {% if plex_event.media_type == 'episode' and plex_event.show_title %}
                        {% if plex_event.show_tmdb_id %}
              <a href="{{ url_for('main.show_detail', tmdb_id=plex_event.show_tmdb_id) }}" class="text-xl sm:text-2xl font-bold text-sky-600 dark:text-sky-400 hover:underline mb-1 sm:mb-2">
                {{ plex_event.show_title }}
              </a>
            {% else %}
              <h3 class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-slate-100 mb-1 sm:mb-2">{{ plex_event.show_title }}</h3>
            {% endif %}
            <div class="text-md sm:text-lg font-semibold text-slate-700 dark:text-slate-200 mb-1">
              {{ plex_event.season_episode }}: {{ plex_event.title }}
            </div>
            {% if plex_event.overview %}
              <p class="text-sm text-slate-600 dark:text-slate-400 mt-2 hidden sm:block">{{ plex_event.overview | truncate(200) }}</p>
            {% endif %}
          {% elif plex_event.media_type == 'movie' and plex_event.title %}
            {% if plex_event.tmdb_id %}
              <a href="{{ url_for('main.movie_detail', tmdb_id=plex_event.tmdb_id) }}" class="text-xl sm:text-2xl font-bold text-sky-600 dark:text-sky-400 hover:underline mb-1 sm:mb-2">
                {{ plex_event.title }}
              </a>
            {% else %}
              <h3 class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-slate-100 mb-1 sm:mb-2">{{ plex_event.title }}</h3>
            {% endif %}
            {% if plex_event.overview %}
              <p class="text-sm text-slate-600 dark:text-slate-400 mt-2 hidden sm:block">{{ plex_event.overview | truncate(200) }}</p>
            {% endif %}
            {% if plex_event.year %}
              <p class="text-sm text-slate-500 dark:text-slate-400">({{ plex_event.year }})</p>
            {% endif %}
          {% else %}
            <h3 class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-slate-100 mb-1 sm:mb-2">{{ plex_event.title or 'Unknown Media' }}</h3>
          {% endif %}

          {# Summary is not directly available in plex_activity_log, would need to parse raw_payload #}
          {# {% if plex_event.raw_payload %}
            {% set payload_data = fromjson(plex_event.raw_payload) %}
            {% if payload_data and payload_data.Metadata and payload_data.Metadata.summary %}
              <p class="text-sm sm:text-base text-slate-600 dark:text-slate-300 mb-2">{{ payload_data.Metadata.summary }}</p>
            {% endif %}
          {% endif %} #}

        </div>
      </div>
    {% else %}
      <div class="bg-slate-100 dark:bg-slate-800 shadow-xl rounded-lg p-6 mb-6 text-slate-600 dark:text-slate-300 text-center">
        <p>No recent Plex activity found for your account, or still waiting for the first webhook event.</p>
        <p class="mt-2 text-sm">Try playing something on Plex!</p>
      </div>
    {% endif %}
  {% else %} 
    <div class="text-center py-10">
      <h2 class="text-3xl sm:text-4xl font-bold text-slate-800 dark:text-slate-100 mb-4">
        ShowNotes
      </h2>
      <p class="text-xl sm:text-2xl text-slate-600 dark:text-slate-300 mb-8">
        The Ultimate Companion for Your Plex Experience.
      </p>
      <a href="{{ url_for('main.login') }}" 
         class="px-6 py-3 bg-sky-500 hover:bg-sky-600 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out text-lg">
        Sign in with Plex
      </a>
    </div>
  {% endif %}
</div>{% endblock page_content %}
