{% extends "admin_layout.html" %}

{% block admin_page_title %}Problem Reports{% endblock %}
{% block admin_page_header %}Problem Reports{% endblock %}

{% block admin_page_content %}
<div class="space-y-6">
    <!-- Header with Filter Tabs -->
    <div>
        <h1 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-4">Problem Reports</h1>

        <!-- Status Filter Tabs -->
        <div class="flex gap-2 mb-4">
            <button onclick="filterReports('open')" data-status="open"
                    class="status-filter-btn px-4 py-2 rounded-lg bg-sky-500 text-white font-medium">
                Open
            </button>
            <button onclick="filterReports('in_progress')" data-status="in_progress"
                    class="status-filter-btn px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium">
                In Progress
            </button>
            <button onclick="filterReports('resolved')" data-status="resolved"
                    class="status-filter-btn px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium">
                Resolved
            </button>
            <button onclick="filterReports('all')" data-status="all"
                    class="status-filter-btn px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium">
                All
            </button>
        </div>
    </div>

    <!-- Reports List -->
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-900">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Title</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">User</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Priority</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Created</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="reports-list" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Report Detail Modal -->
<div id="report-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="if(event.target === this) closeDetailModal()">
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100">Report Details</h2>
                <button onclick="closeDetailModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div id="report-detail-content" class="space-y-4">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Admin Actions Form -->
            <form id="report-action-form" class="mt-6 space-y-4 border-t border-slate-200 dark:border-slate-700 pt-4">
                <input type="hidden" id="action-report-id">

                <div class="grid grid-cols-2 gap-4">
                    <!-- Status -->
                    <div>
                        <label for="action-status" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Status</label>
                        <select id="action-status"
                                class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>

                    <!-- Priority -->
                    <div>
                        <label for="action-priority" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Priority</label>
                        <select id="action-priority"
                                class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <option value="low">Low</option>
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>

                <!-- Admin Notes -->
                <div>
                    <label for="action-admin-notes" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Admin Notes</label>
                    <textarea id="action-admin-notes" rows="3"
                              class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
                              placeholder="Internal notes about this report..."></textarea>
                </div>

                <!-- Buttons -->
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeDetailModal()"
                            class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white rounded-lg">
                        Update Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let reports = [];
let currentFilter = 'open';
let userTimezone = 'UTC'; // Will be set from API response

function formatTimestamp(timestamp, format = 'date') {
    // Convert UTC timestamp to user's timezone
    try {
        // SQLite timestamps are stored as "YYYY-MM-DD HH:MM:SS" in UTC
        // We need to explicitly treat them as UTC by appending 'Z'
        let dateStr = timestamp;
        if (typeof timestamp === 'string' && !timestamp.includes('Z') && !timestamp.includes('+')) {
            // Add 'Z' to indicate this is UTC time
            dateStr = timestamp.replace(' ', 'T') + 'Z';
        }

        const date = new Date(dateStr);
        if (format === 'date') {
            return date.toLocaleDateString('en-US', {
                timeZone: userTimezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        } else {
            return date.toLocaleString('en-US', {
                timeZone: userTimezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }
    } catch (e) {
        // Fallback to browser's local timezone if user timezone is invalid
        return format === 'date'
            ? new Date(timestamp).toLocaleDateString()
            : new Date(timestamp).toLocaleString();
    }
}

// Load reports on page load
document.addEventListener('DOMContentLoaded', () => {
    loadReports('open');
});

async function loadReports(status = 'open') {
    try {
        const url = status === 'all'
            ? '/api/admin/problem-reports'
            : `/api/admin/problem-reports?status=${status}`;

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
            reports = data.reports;
            // Store timezone from response
            if (data.timezone) {
                userTimezone = data.timezone;
            }
            renderReports();
        }
    } catch (error) {
        console.error('Error loading reports:', error);
    }
}

function renderReports() {
    const tbody = document.getElementById('reports-list');

    if (reports.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
                    No ${currentFilter === 'all' ? '' : currentFilter} reports found.
                </td>
            </tr>
        `;
        return;
    }

    const statusColors = {
        open: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300',
        in_progress: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300',
        resolved: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300'
    };

    const priorityColors = {
        low: 'bg-slate-100 text-slate-800 dark:bg-slate-900/30 dark:text-slate-300',
        normal: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300',
        high: 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300',
        urgent: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300'
    };

    tbody.innerHTML = reports.map(report => `
        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
            <td class="px-6 py-4 text-sm text-slate-900 dark:text-slate-100">
                #${report.id}
            </td>
            <td class="px-6 py-4">
                <div class="text-sm font-medium text-slate-900 dark:text-slate-100">${escapeHtml(report.title)}</div>
                <div class="text-xs text-slate-500 dark:text-slate-400">${report.category.replace('_', ' ')}</div>
            </td>
            <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">
                ${report.category.replace('_', ' ')}
            </td>
            <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">
                ${escapeHtml(report.username)}
            </td>
            <td class="px-6 py-4">
                <span class="px-2 py-1 text-xs font-medium rounded ${statusColors[report.status] || statusColors.open}">
                    ${report.status.replace('_', ' ')}
                </span>
            </td>
            <td class="px-6 py-4">
                <span class="px-2 py-1 text-xs font-medium rounded ${priorityColors[report.priority] || priorityColors.normal}">
                    ${report.priority}
                </span>
            </td>
            <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">
                ${formatTimestamp(report.created_at, 'date')}
            </td>
            <td class="px-6 py-4 text-right">
                <button onclick="viewReportDetail(${report.id})"
                        class="text-sky-600 dark:text-sky-400 hover:text-sky-700 dark:hover:text-sky-300">
                    View
                </button>
            </td>
        </tr>
    `).join('');
}

function filterReports(status) {
    currentFilter = status;

    // Update button styles
    document.querySelectorAll('.status-filter-btn').forEach(btn => {
        if (btn.dataset.status === status) {
            btn.className = 'status-filter-btn px-4 py-2 rounded-lg bg-sky-500 text-white font-medium';
        } else {
            btn.className = 'status-filter-btn px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium';
        }
    });

    loadReports(status);
}

async function viewReportDetail(id) {
    const report = reports.find(r => r.id === id);
    if (!report) return;

    // Populate detail content
    const content = document.getElementById('report-detail-content');
    content.innerHTML = `
        <div class="grid grid-cols-2 gap-4">
            <div>
                <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Report ID</h3>
                <p class="mt-1 text-sm text-slate-900 dark:text-slate-100">#${report.id}</p>
            </div>
            <div>
                <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Submitted By</h3>
                <p class="mt-1 text-sm text-slate-900 dark:text-slate-100">${escapeHtml(report.username)}</p>
            </div>
            <div>
                <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Category</h3>
                <p class="mt-1 text-sm text-slate-900 dark:text-slate-100">${report.category.replace('_', ' ')}</p>
            </div>
            <div>
                <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Created</h3>
                <p class="mt-1 text-sm text-slate-900 dark:text-slate-100">${formatTimestamp(report.created_at, 'full')}</p>
            </div>
        </div>

        <div>
            <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Title</h3>
            <p class="mt-1 text-sm text-slate-900 dark:text-slate-100">${escapeHtml(report.title)}</p>
        </div>

        <div>
            <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Description</h3>
            <p class="mt-1 text-sm text-slate-900 dark:text-slate-100 whitespace-pre-wrap">${escapeHtml(report.description)}</p>
        </div>

        ${report.show_title ? `
        <div>
            <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Related Show</h3>
            <p class="mt-1 text-sm text-slate-900 dark:text-slate-100">${escapeHtml(report.show_title)}</p>
        </div>
        ` : ''}

        ${report.movie_title ? `
        <div>
            <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Related Movie</h3>
            <p class="mt-1 text-sm text-slate-900 dark:text-slate-100">${escapeHtml(report.movie_title)}</p>
        </div>
        ` : ''}

        ${report.episode_title ? `
        <div>
            <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Related Episode</h3>
            <p class="mt-1 text-sm text-slate-900 dark:text-slate-100">${escapeHtml(report.episode_title)}</p>
        </div>
        ` : ''}
    `;

    // Populate form
    document.getElementById('action-report-id').value = report.id;
    document.getElementById('action-status').value = report.status;
    document.getElementById('action-priority').value = report.priority;
    document.getElementById('action-admin-notes').value = report.admin_notes || '';

    // Show modal
    document.getElementById('report-detail-modal').classList.remove('hidden');
    document.getElementById('report-detail-modal').classList.add('flex');
}

function closeDetailModal() {
    document.getElementById('report-detail-modal').classList.add('hidden');
    document.getElementById('report-detail-modal').classList.remove('flex');
}

document.getElementById('report-action-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const reportId = document.getElementById('action-report-id').value;
    const data = {
        status: document.getElementById('action-status').value,
        priority: document.getElementById('action-priority').value,
        admin_notes: document.getElementById('action-admin-notes').value
    };

    try {
        const response = await fetch(`/api/admin/problem-reports/${reportId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            closeDetailModal();
            loadReports(currentFilter);
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error updating report:', error);
        alert('Error updating report');
    }
});

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
