{% extends "profile_base.html" %}

{% block profile_content %}
<!-- Sub-Navigation Tabs -->
<div class="bg-slate-50 dark:bg-slate-900/50 -mx-6 -mt-6 mb-6">
    <div class="flex items-center justify-between px-6 pt-4 pb-2">
        <nav class="flex gap-1 flex-1">
            <button onclick="changeFilter('mine')" class="filter-btn px-4 py-3 text-sm font-medium transition-colors rounded-t-lg bg-white dark:bg-slate-800 text-sky-600 dark:text-sky-400 border-b-2 border-sky-600 dark:border-sky-400" data-filter="mine">
                <svg class="w-4 h-4 inline-block mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                My Lists
            </button>
            <button onclick="changeFilter('shared')" class="filter-btn px-4 py-3 text-sm font-medium transition-colors rounded-t-lg text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800/50" data-filter="shared">
                <svg class="w-4 h-4 inline-block mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
                Shared Lists
            </button>
            <button onclick="changeFilter('public')" class="filter-btn px-4 py-3 text-sm font-medium transition-colors rounded-t-lg text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800/50" data-filter="public">
                <svg class="w-4 h-4 inline-block mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                All Public
            </button>
        </nav>
        <button onclick="showCreateListModal()" class="px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out ml-4">
            <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Create New List
        </button>
    </div>
</div>

<div>

    <!-- Lists Grid -->
    <div id="lists-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        <!-- Lists will be loaded here -->
        <div class="col-span-full text-center py-12">
            <svg class="w-12 h-12 mx-auto text-slate-400 dark:text-slate-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
            </svg>
            <p class="text-slate-500 dark:text-slate-400">Loading lists...</p>
        </div>
    </div>
</div>

<!-- Create List Modal -->
<div id="create-list-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-4">Create New List</h3>
        <form id="create-list-form" onsubmit="createList(event)">
            <div class="mb-4">
                <label for="list-name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">List Name *</label>
                <input type="text" id="list-name" required class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500">
            </div>
            <div class="mb-4">
                <label for="list-description" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Description (optional)</label>
                <textarea id="list-description" rows="3" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500"></textarea>
            </div>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" id="list-is-public" class="w-4 h-4 text-sky-600 border-slate-300 dark:border-slate-600 rounded focus:ring-sky-500 focus:ring-offset-0">
                    <span class="ml-2 text-sm text-slate-700 dark:text-slate-300">Make this list public (others can view it)</span>
                </label>
            </div>
            <div class="flex gap-2 justify-end">
                <button type="button" onclick="hideCreateListModal()" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white rounded-lg">
                    Create List
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit List Modal -->
<div id="edit-list-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-4">Edit List</h3>
        <form id="edit-list-form" onsubmit="updateList(event)">
            <input type="hidden" id="edit-list-id">
            <div class="mb-4">
                <label for="edit-list-name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">List Name *</label>
                <input type="text" id="edit-list-name" required class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500">
            </div>
            <div class="mb-4">
                <label for="edit-list-description" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Description (optional)</label>
                <textarea id="edit-list-description" rows="3" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500"></textarea>
            </div>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" id="edit-list-is-public" class="w-4 h-4 text-sky-600 border-slate-300 dark:border-slate-600 rounded focus:ring-sky-500 focus:ring-offset-0">
                    <span class="ml-2 text-sm text-slate-700 dark:text-slate-300">Make this list public (others can view it)</span>
                </label>
            </div>
            <div class="flex gap-2 justify-end">
                <button type="button" onclick="hideEditListModal()" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white rounded-lg">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentFilter = 'mine';

// Load lists on page load
document.addEventListener('DOMContentLoaded', () => loadLists(currentFilter));

function changeFilter(filter) {
    currentFilter = filter;

    // Update button styles
    document.querySelectorAll('.filter-btn').forEach(btn => {
        if (btn.dataset.filter === filter) {
            btn.className = 'filter-btn px-4 py-3 text-sm font-medium transition-colors rounded-t-lg bg-white dark:bg-slate-800 text-sky-600 dark:text-sky-400 border-b-2 border-sky-600 dark:border-sky-400';
        } else {
            btn.className = 'filter-btn px-4 py-3 text-sm font-medium transition-colors rounded-t-lg text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800/50';
        }
    });

    loadLists(filter);
}

async function loadLists(filter = 'mine') {
    try {
        const response = await fetch(`/api/profile/lists?filter=${filter}`);
        const data = await response.json();

        const container = document.getElementById('lists-container');

        if (data.success && data.lists && data.lists.length > 0) {
            container.innerHTML = data.lists.map(list => `
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow-md hover:shadow-lg transition-shadow p-4 border border-slate-200 dark:border-slate-700">
                    <div class="flex items-start justify-between mb-2">
                        <a href="/profile/lists/${list.id}" class="flex-1">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100 hover:text-sky-600 dark:hover:text-sky-400">
                                ${list.name}
                                ${list.is_public ? '<svg class="w-4 h-4 inline-block ml-1 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg>' : ''}
                            </h3>
                            ${!list.is_owner ? `<p class="text-xs text-slate-500 dark:text-slate-400">by ${list.owner_username}</p>` : ''}
                        </a>
                        ${list.is_owner ? `
                        <div class="flex gap-1">
                            <button onclick="showEditListModal(${list.id}, '${list.name.replace(/'/g, "\\'")}', '${(list.description || '').replace(/'/g, "\\'")}', ${list.is_public}, event)" class="p-1 text-slate-500 hover:text-sky-600 dark:text-slate-400 dark:hover:text-sky-400" title="Edit list">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="deleteList(${list.id}, '${list.name.replace(/'/g, "\\'")}', event)" class="p-1 text-slate-500 hover:text-red-600 dark:text-slate-400 dark:hover:text-red-400" title="Delete list">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                    ${list.description ? `<p class="text-sm text-slate-600 dark:text-slate-400 mb-3 line-clamp-2">${list.description}</p>` : ''}
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-slate-500 dark:text-slate-400">${list.item_count} ${list.item_count === 1 ? 'item' : 'items'}</span>
                        <a href="/profile/lists/${list.id}" class="text-sky-600 dark:text-sky-400 hover:underline">View â†’</a>
                    </div>
                </div>
            `).join('');
        } else {
            const emptyMessages = {
                'mine': {
                    icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2',
                    message: "You haven't created any lists yet",
                    action: `<button onclick="showCreateListModal()" class="px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white rounded-lg">Create Your First List</button>`
                },
                'shared': {
                    icon: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z',
                    message: "No shared lists available yet",
                    action: '<p class="text-sm text-slate-400 dark:text-slate-500">Lists shared by other users will appear here</p>'
                },
                'public': {
                    icon: 'M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z',
                    message: "No public lists available",
                    action: '<p class="text-sm text-slate-400 dark:text-slate-500">Public lists from all users will appear here</p>'
                }
            };

            const emptyState = emptyMessages[filter] || emptyMessages['mine'];

            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <svg class="w-16 h-16 mx-auto text-slate-300 dark:text-slate-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${emptyState.icon}"></path>
                    </svg>
                    <p class="text-slate-500 dark:text-slate-400 mb-4">${emptyState.message}</p>
                    ${emptyState.action}
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading lists:', error);
        document.getElementById('lists-container').innerHTML = `
            <div class="col-span-full text-center py-12 text-red-500">
                Error loading lists. Please try again.
            </div>
        `;
    }
}

function showCreateListModal() {
    document.getElementById('create-list-modal').classList.remove('hidden');
    document.getElementById('list-name').focus();
}

function hideCreateListModal() {
    document.getElementById('create-list-modal').classList.add('hidden');
    document.getElementById('create-list-form').reset();
}

async function createList(event) {
    event.preventDefault();

    const name = document.getElementById('list-name').value;
    const description = document.getElementById('list-description').value;
    const is_public = document.getElementById('list-is-public').checked;

    try {
        const response = await fetch('/api/profile/lists', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, description, is_public})
        });

        const data = await response.json();

        if (data.success) {
            hideCreateListModal();
            loadLists(currentFilter);
        } else {
            alert('Error creating list: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error creating list');
    }
}

function showEditListModal(listId, name, description, isPublic, event) {
    event.preventDefault();
    event.stopPropagation();

    document.getElementById('edit-list-id').value = listId;
    document.getElementById('edit-list-name').value = name;
    document.getElementById('edit-list-description').value = description;
    document.getElementById('edit-list-is-public').checked = isPublic;
    document.getElementById('edit-list-modal').classList.remove('hidden');
    document.getElementById('edit-list-name').focus();
}

function hideEditListModal() {
    document.getElementById('edit-list-modal').classList.add('hidden');
    document.getElementById('edit-list-form').reset();
}

async function updateList(event) {
    event.preventDefault();

    const listId = document.getElementById('edit-list-id').value;
    const name = document.getElementById('edit-list-name').value;
    const description = document.getElementById('edit-list-description').value;
    const is_public = document.getElementById('edit-list-is-public').checked;

    try {
        const response = await fetch(`/api/profile/lists/${listId}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, description, is_public})
        });

        const data = await response.json();

        if (data.success) {
            hideEditListModal();
            loadLists(currentFilter);
        } else {
            alert('Error updating list: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error updating list');
    }
}

async function deleteList(listId, listName, event) {
    event.preventDefault();
    event.stopPropagation();

    if (!confirm(`Are you sure you want to delete "${listName}"? This will remove all items in the list.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/profile/lists/${listId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            loadLists();
        } else {
            alert('Error deleting list: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting list');
    }
}
</script>
{% endblock %}
