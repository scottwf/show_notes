{% extends "layout.html" %}

{% block page_title %}{{ episode.title }} - {{ show.title }}{% endblock %}
{% block title %}{{ episode.title }} - {{ show.title }}{% endblock %} {# More specific title for the tab/window #}

{% block content %}
<div class="container mx-auto px-2 sm:px-4 py-6 sm:py-8">
    <div class="mb-4">
        <a href="{{ url_for('main.show_detail', tmdb_id=show.tmdb_id) }}" class="text-sky-500 hover:text-sky-700 dark:text-sky-400 dark:hover:text-sky-300 transition-colors duration-150 text-sm sm:text-base">
            &larr; Back to {{ show.title }}
        </a>
    </div>

    <div class="bg-white dark:bg-slate-800 shadow-xl rounded-lg overflow-hidden">
        {# Optional Fanart Background for a header section - can be added if desired #}
        {# For example:
        <div class="h-48 sm:h-64 md:h-72 bg-cover bg-center" style="background-image: url('{{ show.cached_fanart_url if show.cached_fanart_url else url_for('static', filename='logos/placeholder_background.png') }}');">
             <div class="absolute inset-0 bg-gradient-to-t from-slate-800 via-slate-800/70 to-transparent"></div>
        </div>
        #}

        <div class="p-4 sm:p-6 md:p-8">
            <div class="md:flex md:space-x-6 lg:space-x-8">
                <div class="md:w-1/3 lg:w-1/4 flex-shrink-0 mb-6 md:mb-0">
                    <img src="{{ show.cached_poster_url if show.cached_poster_url else url_for('static', filename='logos/placeholder_poster.png') }}"
                         onerror="this.onerror=null; this.src='{{ url_for('static', filename='logos/placeholder_poster.png') }}';"
                         alt="Poster for {{ show.title }}"
                         class="rounded-lg shadow-md w-full aspect-[2/3] object-cover">
                </div>
                <div class="md:w-2/3 lg:w-3/4 min-w-0"> {# Ensure flex child can shrink #}
                    <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-1 truncate" title="{{ episode.title }}">{{ episode.title }}</h1>
                    <p class="text-md sm:text-lg text-gray-600 dark:text-gray-400 mb-3">
                        Season {{ season_number }}, Episode {{ episode.episode_number }}
                    </p>

                    <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mb-4 text-sm sm:text-base">
                        {% if episode.is_available %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs sm:text-sm font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">
                                <svg class="-ml-0.5 mr-1 h-4 w-4 text-green-500 dark:text-green-400" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3"></circle></svg>
                                Available
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs sm:text-sm font-medium bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                                Not Available
                            </span>
                        {% endif %}
                        <span class="text-gray-500 dark:text-gray-400">
                            <strong class="font-medium text-gray-700 dark:text-gray-300">Air Date:</strong> {{ episode.formatted_air_date }}
                        </span>
                        {# Add runtime if available from sonarr_episodes.runtime (INTEGER, minutes) #}
                        {% if episode.runtime %}
                        <span class="text-gray-500 dark:text-gray-400">
                           <strong class="font-medium text-gray-700 dark:text-gray-300">Runtime:</strong> {{ episode.runtime }} min
                        </span>
                        {% endif %}
                        {# Add rating if available from sonarr_episodes.ratings_value (REAL) #}
                        {% if episode.ratings_value and episode.ratings_value > 0 %}
                        <span class="text-gray-500 dark:text-gray-400">
                           <strong class="font-medium text-gray-700 dark:text-gray-300">Rating:</strong> {{ "%.1f" | format(episode.ratings_value) }}/10
                        </span>
                        {% endif %}
                    </div>

                    <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-5 sm:mt-6 mb-2">Summary</h2>
                    <p class="text-gray-700 dark:text-gray-300 leading-relaxed prose dark:prose-invert max-w-none">
                        {{ episode.overview | default('No summary available for this episode.') }}
                    </p>

                    <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-8 mb-2">Cast</h2>
                    {% if episode_characters and episode_characters|length > 0 %}
                    <div class="flex flex-wrap gap-4">
                        {% for c in episode_characters %}
                        <a href="{{ url_for('main.character_detail', show_id=show.tmdb_id, season_number=season_number, episode_number=episode.episode_number, actor_id=c.actor_id) }}" style="text-decoration: none;">
                        <div class="flex flex-row items-center w-full max-w-md bg-slate-50 dark:bg-slate-700 rounded-lg p-2 shadow mb-2 hover:bg-slate-100 dark:hover:bg-slate-600 transition">
                            <img src="{{ c.actor_thumb }}" alt="{{ c.actor_name }}" class="w-16 h-16 rounded-full object-cover mr-4 border border-slate-200 dark:border-slate-600" onerror="this.onerror=null;this.src='{{ url_for('static', filename='logos/placeholder_poster.png') }}';">
                            <div class="flex flex-col min-w-0">
                                <div class="text-base font-bold text-gray-800 dark:text-gray-100 truncate" title="{{ c.character_name }}">{{ c.character_name }}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-300 truncate" title="{{ c.actor_name }}">{{ c.actor_name }}</div>
                            </div>
                        </div>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-gray-500 dark:text-gray-400">No cast information available for this episode.</div>
                    {% endif %}

                    {# Placeholder for future watch status/actions - More complex, requires user-specific data and actions #}
                    {#
                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Your Watch Status</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Feature coming soon: Track your watched status and progress.</p>
                        <div class="flex space-x-3 mt-3">
                            <button class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg focus:ring-4 focus:ring-blue-300 dark:bg-blue-500 dark:hover:bg-blue-600 focus:outline-none dark:focus:ring-blue-800">Mark as Watched</button>
                            <button class="px-4 py-2 text-sm font-medium text-gray-900 bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">Set Progress</button>
                        </div>
                    </div>
                    #}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
