{% extends "layout.html" %}

{% block page_title %}Discover{% endblock %}

{% block page_content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-100 mb-2">Discover</h1>
        <p class="text-lg text-slate-600 dark:text-slate-400">Explore trending shows and upcoming movies</p>
    </div>

    <!-- Tab Navigation -->
    <div class="flex gap-2 mb-6 border-b border-slate-200 dark:border-slate-700">
        <button onclick="showTab('trending')"
                class="tab-button px-6 py-3 font-medium transition-colors border-b-2 border-sky-500 text-sky-600 dark:text-sky-400"
                data-tab="trending">
            Trending
        </button>
        <button onclick="showTab('upcoming')"
                class="tab-button px-6 py-3 font-medium transition-colors border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100"
                data-tab="upcoming">
            Upcoming Movies
        </button>
    </div>

    <!-- Trending Tab -->
    <div id="trending-tab" class="tab-content">
        <div id="trending-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6">
            <!-- Loading state -->
            <div class="col-span-full text-center py-12">
                <p class="text-slate-500 dark:text-slate-400">Loading trending content...</p>
            </div>
        </div>
    </div>

    <!-- Upcoming Tab -->
    <div id="upcoming-tab" class="tab-content hidden">
        <div id="upcoming-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6">
            <!-- Loading state -->
            <div class="col-span-full text-center py-12">
                <p class="text-slate-500 dark:text-slate-400">Loading upcoming movies...</p>
            </div>
        </div>
    </div>

    <!-- Not Configured Message -->
    {% if not jellyseer_url %}
    <div class="bg-yellow-100 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700 rounded-lg p-6 mt-6">
        <div class="flex items-start gap-3">
            <svg class="w-6 h-6 text-yellow-600 dark:text-yellow-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
            </svg>
            <div>
                <h3 class="text-lg font-semibold text-yellow-800 dark:text-yellow-200 mb-1">Jellyseerr Not Configured</h3>
                <p class="text-sm text-yellow-700 dark:text-yellow-300">
                    The Discover feature requires Jellyseerr integration to be set up by an administrator.
                    Contact your admin to enable trending and upcoming content discovery.
                </p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
let currentTab = 'trending';
let trendingData = null;
let upcomingData = null;

// Load content on page load
document.addEventListener('DOMContentLoaded', () => {
    {% if jellyseer_url %}
    loadTrending();
    {% endif %}
});

function showTab(tab) {
    currentTab = tab;

    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        if (btn.dataset.tab === tab) {
            btn.className = 'tab-button px-6 py-3 font-medium transition-colors border-b-2 border-sky-500 text-sky-600 dark:text-sky-400';
        } else {
            btn.className = 'tab-button px-6 py-3 font-medium transition-colors border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100';
        }
    });

    // Show/hide tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    document.getElementById(`${tab}-tab`).classList.remove('hidden');

    // Load data if not already loaded
    if (tab === 'trending' && !trendingData) {
        loadTrending();
    } else if (tab === 'upcoming' && !upcomingData) {
        loadUpcoming();
    }
}

async function loadTrending() {
    try {
        const response = await fetch('/api/jellyseer/trending');
        const data = await response.json();

        if (data.success && data.trending) {
            trendingData = data.trending;
            renderContent('trending', data.trending);
        } else {
            showError('trending', data.error || 'Failed to load trending content');
        }
    } catch (error) {
        console.error('Error loading trending:', error);
        showError('trending', 'Error connecting to Jellyseerr');
    }
}

async function loadUpcoming() {
    try {
        const response = await fetch('/api/jellyseer/upcoming');
        const data = await response.json();

        if (data.success && data.upcoming) {
            upcomingData = data.upcoming;
            renderContent('upcoming', data.upcoming);
        } else {
            showError('upcoming', data.error || 'Failed to load upcoming movies');
        }
    } catch (error) {
        console.error('Error loading upcoming:', error);
        showError('upcoming', 'Error connecting to Jellyseerr');
    }
}

function renderContent(type, items) {
    const container = document.getElementById(`${type}-container`);

    if (!items || items.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-12">
                <svg class="w-16 h-16 mx-auto text-slate-300 dark:text-slate-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"></path>
                </svg>
                <p class="text-slate-500 dark:text-slate-400">No ${type} content available</p>
            </div>
        `;
        return;
    }

    container.innerHTML = items.map(item => {
        const posterUrl = item.poster_path
            ? `https://image.tmdb.org/t/p/w500${item.poster_path}`
            : '/static/logos/placeholder_poster.png';

        const rating = item.vote_average ? `★ ${item.vote_average.toFixed(1)}` : '';
        const jellyseerLink = '{{ jellyseer_url }}' + (item.media_type === 'movie' ? `/movie/${item.tmdb_id}` : `/tv/${item.tmdb_id}`);

        return `
            <div class="group relative">
                <a href="${jellyseerLink}" target="_blank" rel="noopener noreferrer" class="block">
                    <div class="relative aspect-[2/3] rounded-lg overflow-hidden bg-slate-200 dark:bg-slate-700 shadow-md hover:shadow-xl transition-all transform group-hover:scale-105">
                        <img src="${posterUrl}"
                             alt="${item.title}"
                             class="w-full h-full object-cover"
                             onerror="this.src='/static/logos/placeholder_poster.png'">

                        <!-- Rating badge -->
                        ${rating ? `
                        <div class="absolute top-2 right-2 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded">
                            ${rating}
                        </div>
                        ` : ''}

                        <!-- Media type badge -->
                        <div class="absolute top-2 left-2 bg-sky-500 text-white text-xs px-2 py-1 rounded uppercase font-semibold">
                            ${item.media_type === 'movie' ? 'Movie' : 'TV'}
                        </div>

                        <!-- Overlay on hover -->
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-75 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100">
                            <div class="text-white text-center px-4">
                                <p class="font-semibold mb-2">${item.title}</p>
                                ${item.year ? `<p class="text-sm text-slate-300">${item.year}</p>` : ''}
                                <div class="mt-3 text-sm bg-sky-500 hover:bg-sky-600 px-3 py-1 rounded inline-block">
                                    View on Jellyseerr →
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
                <div class="mt-2">
                    <a href="${jellyseerLink}" target="_blank" rel="noopener noreferrer"
                       class="text-sm font-medium text-slate-800 dark:text-slate-100 hover:text-sky-600 dark:hover:text-sky-400 line-clamp-2">
                        ${item.title}
                    </a>
                    ${item.year ? `<p class="text-xs text-slate-500 dark:text-slate-400">${item.year}</p>` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function showError(type, message) {
    const container = document.getElementById(`${type}-container`);
    container.innerHTML = `
        <div class="col-span-full text-center py-12">
            <svg class="w-16 h-16 mx-auto text-red-300 dark:text-red-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-red-600 dark:text-red-400 mb-2 font-medium">Error Loading Content</p>
            <p class="text-sm text-slate-500 dark:text-slate-400">${message}</p>
        </div>
    `;
}
</script>
{% endblock %}
