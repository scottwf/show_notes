{% extends "layout.html" %}

{% block page_title %}{{ character.character_name if character else character_name }} - Character Detail{% endblock %}
{% block title %}{{ character.character_name if character else character_name }} - Character Detail{% endblock %}

{% block content %}
<div class="container mx-auto px-2 sm:px-4 py-6 sm:py-8">
    <div class="mb-4">
        <a href="{{ url_for('main.episode_detail', tmdb_id=show_id, season_number=season_number, episode_number=episode_number) }}" class="text-sky-500 hover:text-sky-700 dark:text-sky-400 dark:hover:text-sky-300 transition-colors duration-150 text-sm sm:text-base">
            &larr; Back to Episode
        </a>
    </div>
    <div class="bg-white dark:bg-slate-800 shadow-xl rounded-lg overflow-hidden p-6 flex flex-col md:flex-row items-start gap-6">
        <div class="flex-shrink-0">
            <img src="{{ character.actor_thumb if character else url_for('static', filename='logos/placeholder_poster.png') }}"
                 alt="{{ character.actor_name if character else character_name }}"
                 class="w-32 h-32 rounded-full object-cover border border-slate-200 dark:border-slate-600 mb-4">
        </div>
        <div class="flex-1 min-w-0">
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-1">{{ character.character_name if character else character_name }}</h1>
            <div class="text-lg text-gray-600 dark:text-gray-300 mb-2">Played by <span class="font-semibold">{{ character.actor_name if character else 'Unknown' }}</span></div>
            <div class="mb-4">
                <span class="inline-block bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded px-3 py-1 text-xs font-medium mr-2">Season {{ season_number }}</span>
                <span class="inline-block bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded px-3 py-1 text-xs font-medium">Episode {{ episode_number }}</span>
            </div>
            <hr class="my-4 border-slate-200 dark:border-slate-700">

            <!-- Tab Navigation -->
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav id="character-tabs" class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button data-tab="summary" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-sky-600 dark:text-sky-400 border-sky-500">Summary</button>
                    <button data-tab="relationships" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 border-transparent">Relationships</button>
                    <button data-tab="events" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 border-transparent">Key Events</button>
                    <button data-tab="chat" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 border-transparent">Chat</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="mt-6">
                {% if llm_error %}
                    <div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-200 px-4 py-3 rounded-md" role="alert">
                        <strong class="font-bold">Error:</strong>
                        <span class="block sm:inline">{{ llm_error }}</span>
                    </div>
                {% elif not llm_cards %}
                    <div class="bg-blue-100 dark:bg-blue-900 border border-blue-400 dark:border-blue-700 text-blue-700 dark:text-blue-200 px-4 py-3 rounded-md" role="alert">
                        No summary information is available for this character at this point in the story.
                    </div>
                {% else %}
                    <!-- Summary Tab -->
                    <div id="tab-summary" class="tab-content space-y-6">
                        {% if llm_cards.background %}
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Character Background & Role</h3>
                            <div class="prose prose-slate dark:prose-invert max-w-none">
                                {{ llm_cards.background | safe }}
                            </div>
                        </div>
                        {% endif %}
                        {% if llm_cards.traits %}
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Personality & Traits</h3>
                            <div class="flex flex-wrap gap-2">
                                {% for trait in llm_cards.traits %}
                                <span class="inline-block bg-sky-100 dark:bg-sky-900/50 text-sky-800 dark:text-sky-200 rounded-full px-3 py-1 text-sm font-medium">{{ trait | striptags }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% if llm_cards.motivations %}
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Motivations & Conflicts</h3>
                            <div class="prose prose-slate dark:prose-invert max-w-none">
                                {{ llm_cards.motivations | safe }}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Relationships Tab -->
                    <div id="tab-relationships" class="tab-content hidden space-y-4">
                        {% if llm_cards.relationships %}
                            {% for rel in llm_cards.relationships %}
                            <div class="p-4 bg-slate-50 dark:bg-slate-900/50 rounded-md border border-slate-200 dark:border-slate-700">
                                <div class="font-bold text-sky-700 dark:text-sky-400">{{ rel.name }}</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400 mb-1">{{ rel.role }}</div>
                                <p class="text-sm text-slate-700 dark:text-slate-300">{{ rel.description }}</p>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-slate-500 dark:text-slate-400">No relationship data available.</p>
                        {% endif %}
                    </div>

                    <!-- Key Events Tab -->
                    <div id="tab-events" class="tab-content hidden">
                        {% if llm_cards.events %}
                            <div class="prose prose-slate dark:prose-invert max-w-none">
                                <ul class="space-y-2">
                                    {% for event in llm_cards.events %}
                                    <li>{{ event }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% else %}
                            <p class="text-slate-500 dark:text-slate-400">No key events data available.</p>
                        {% endif %}
                    </div>
                {% endif %}

                <!-- Chat Tab -->
                <div id="tab-chat" class="tab-content hidden">
                    <div id="chat-container" class="bg-white dark:bg-slate-800">
                        <div id="chat-history" class="mb-4 h-64 overflow-y-auto p-4 border rounded-md bg-slate-50 dark:bg-slate-900/50">
                            <!-- Chat messages will be injected here by JS -->
                        </div>
                        <form id="chat-form">
                            <div class="flex">
                                <input type="text" id="chat-input" class="w-full p-2 border rounded-l-md dark:bg-slate-700 dark:border-slate-600" placeholder="Ask a question about {{ character.character_name | e }}...">
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-r-md hover:bg-blue-700">Send</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            {% if llm_last_updated or llm_source %}
            <div class="text-xs text-slate-500 dark:text-slate-400 mt-6 pt-4 border-t border-slate-200 dark:border-slate-700 text-center">
                <span>Summary generated on {{ llm_last_updated if llm_last_updated else 'Unknown' }}</span>
                <span class="mx-2">|</span>
                <span>Source: {{ llm_source if llm_source else 'Unknown' }}</span>
                <span class="mx-2">|</span>
                <a href="{{ url_for('main.character_detail', show_id=show_id, season_number=season_number, episode_number=episode_number, character_id=character_id) }}?refresh=true"
                   class="text-sky-500 hover:text-sky-700 dark:text-sky-400 dark:hover:text-sky-300 text-xs underline"
                   title="Regenerate character summary with current prompts">
                   ðŸ”„ Refresh Summary
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching logic
    const tabs = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const target = tab.dataset.tab;

            // Update button styles
            tabs.forEach(t => {
                if (t === tab) {
                    t.classList.add('text-sky-600', 'dark:text-sky-400', 'border-sky-500');
                    t.classList.remove('text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400', 'dark:hover:text-gray-200', 'border-transparent');
                } else {
                    t.classList.remove('text-sky-600', 'dark:text-sky-400', 'border-sky-500');
                    t.classList.add('text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400', 'dark:hover:text-gray-200', 'border-transparent');
                }
            });

            // Show/hide content
            tabContents.forEach(content => {
                if (content.id === `tab-${target}`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
        });
    });

    // Chat form logic
    const chatForm = document.getElementById('chat-form');
    if (chatForm) {
        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            input.value = '';

            const chatHistory = document.getElementById('chat-history');
            const userMessageDiv = document.createElement('div');
            userMessageDiv.classList.add('mb-2', 'text-right');
            userMessageDiv.innerHTML = `<div class="inline-block bg-blue-100 dark:bg-blue-800 text-blue-900 dark:text-blue-100 rounded-lg px-3 py-2 max-w-md"><b>You:</b> ${message}</div>`;
            chatHistory.appendChild(userMessageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            try {
                const response = await fetch("{{ url_for('main.character_detail', show_id=show_id, season_number=season_number, episode_number=episode_number, character_id=character_id) }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                const botMessageDiv = document.createElement('div');
                botMessageDiv.classList.add('mb-2', 'text-left');
                botMessageDiv.innerHTML = `<div class="inline-block bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg px-3 py-2 max-w-md"><b>{{ character.character_name | e }}:</b> ${data.reply}</div>`;
                chatHistory.appendChild(botMessageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;

            } catch (error) {
                console.error('Chat error:', error);
                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.classList.add('mb-2', 'text-left');
                errorMessageDiv.innerHTML = `<div class="inline-block bg-red-100 dark:bg-red-800 text-red-900 dark:text-red-100 rounded-lg px-3 py-2 max-w-md"><b>System:</b> Sorry, something went wrong.</div>`;
                chatHistory.appendChild(errorMessageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        });
    }
});
</script>
{% endblock %}
