{% extends "admin_layout.html" %}

{% block admin_page_title %}Service Settings{% endblock %}

{% block admin_extra_js %}
  <script src="{{ url_for('static', filename='admin_settings.js') }}"></script>
{% endblock %}

{% block admin_page_header %}Service Configuration{% endblock %}

{% block admin_page_content %}
<h2 class="text-2xl sm:text-3xl font-bold text-slate-800 dark:text-slate-100 mb-6 sm:mb-8 text-center">Admin & Service Settings</h2>
<form method="post" class="space-y-8 max-w-2xl mx-auto">
  <!-- Service Settings Group -->
    <!-- Ollama -->
    <div class="bg-slate-100 dark:bg-slate-800 shadow-lg rounded-lg p-4 sm:p-6">
      <div class="flex items-center gap-x-3 mb-2">
        <span class="inline-block w-12 h-12 sm:w-14 sm:h-14">
          <img src="{{ url_for('static', filename='logos/ollama-light.png') }}" alt="Ollama logo" class="w-full h-full object-contain dark:hidden">
          <img src="{{ url_for('static', filename='logos/ollama-dark.png') }}" alt="Ollama logo dark" class="w-full h-full object-contain hidden dark:inline">
        </span>
        <span class="font-semibold text-xl text-slate-800 dark:text-slate-100">Ollama</span>
        <span id="ollama_status" class="ml-auto text-sm text-slate-600 dark:text-slate-300"></span>
        <!-- Note: Ollama test button is not part of this specific subtask's scope for new JS -->
      </div>
      <p class="text-slate-500 dark:text-slate-400 text-sm mb-4">Ollama provides AI-powered features for enhanced automation and recommendations.</p>
      <label class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1" for="ollama_url">URL</label>
      <input type="text" id="ollama_url" name="ollama_url" value="{{ settings.ollama_url }}" class="border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-slate-50 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
      <button type="button" data-service="ollama" class="test-btn bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 rounded-md shadow-sm mt-3 text-sm font-medium">Test</button>
    </div>

    <!-- Plex OAuth Settings -->
    <div class="bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-400 dark:border-yellow-600 shadow-lg rounded-lg p-4 sm:p-6 mb-8">
      <div class="flex items-center gap-x-3 mb-3">
        <span class="inline-block w-12 h-12 sm:w-14 sm:h-14">
          <img src="{{ url_for('static', filename='logos/plex-light.png') }}" alt="Plex logo" class="w-full h-full object-contain dark:hidden">
          <img src="{{ url_for('static', filename='logos/plex-dark.png') }}" alt="Plex logo dark" class="w-full h-full object-contain hidden dark:inline">
        </span>
        <h3 class="text-xl font-bold text-yellow-700 dark:text-yellow-400">Plex OAuth Authentication</h3>
        <span id="test-result-plex" class="ml-auto text-sm"></span>
      </div>
      <div class="text-sm text-yellow-800 dark:text-yellow-300 mb-4">
        <p>Set up Plex OAuth to enable user authentication with Plex accounts. You do <strong>not</strong> need to register your app with Plexâ€”just use a unique Client ID for your app. See <a href="https://forums.plex.tv/t/authenticating-with-plex/609370" class="text-sky-600 dark:text-sky-400 underline" target="_blank">Plex OAuth Guide</a> for details.</p>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1" for="plex_client_id">
            Plex Client ID
            <span class="ml-1 text-xs text-slate-500 dark:text-slate-400" title="Use any unique string (e.g. 'shownotes-app-1234'). This identifies your app to Plex.">(?)</span>
          </label>
          <input type="text" id="plex_client_id" name="plex_client_id" value="{{ settings.plex_client_id or '' }}" class="border-yellow-400 dark:border-yellow-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-50 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
        </div>
        <!-- Plex URL and Token are usually taken from the main settings table, not directly here with Client ID -->
        <!-- Assuming plex_url and plex_token are configured elsewhere and test button will use them -->
      </div>
      <button type="button" class="test-connection-btn bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded text-sm mt-3" data-service-name="plex">Test Plex Connection</button>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var btn = document.getElementById('gen-plex-secret');
          if (btn) {
            btn.addEventListener('click', function() {
              fetch('/admin/gen_plex_secret', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                  document.getElementById('plex_client_secret').value = data.secret;
                });
            });
          }
        });
      </script>
    </div>

    <!-- Pushover -->
    <div class="bg-slate-100 dark:bg-slate-800 shadow-lg rounded-lg p-4 sm:p-6">
      <div class="flex items-center gap-x-3 mb-2">
        <span class="inline-block w-12 h-12 sm:w-14 sm:h-14">
          <img src="{{ url_for('static', filename='logos/pushover-light.png') }}" alt="Pushover logo" class="w-full h-full object-contain dark:hidden">
          <img src="{{ url_for('static', filename='logos/pushover-dark.png') }}" alt="Pushover logo dark" class="w-full h-full object-contain hidden dark:inline">
        </span>
        <span class="font-semibold text-xl text-slate-800 dark:text-slate-100">Pushover</span>
        <span id="pushover_status" class="ml-auto text-sm text-slate-600 dark:text-slate-300"></span>
      </div>
      <p class="text-slate-500 dark:text-slate-400 text-sm mb-4">Pushover sends notifications to your device when important events occur.</p>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1" for="pushover_token">API Token</label>
          <input type="text" id="pushover_token" name="pushover_token" value="{{ settings.pushover_token }}" class="border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-slate-50 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
        </div>
        <div>
          <div class="flex items-center justify-between mb-1">
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-200" for="pushover_key">User Key</label>
            <a href="https://pushover.net/" target="_blank" class="text-sky-500 dark:text-sky-400 text-xs hover:underline">Get your key</a>
          </div>
          <input type="text" id="pushover_key" name="pushover_key" value="{{ settings.pushover_key }}" class="border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-slate-50 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
        </div>
      </div>
      <button type="button" id="pushover-test-btn" class="bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 rounded-md shadow-sm mt-4 text-sm font-medium">Send Test Notification</button>
    </div>

    <!-- Sonarr, Radarr, Bazarr Grouped Card -->
    <div class="bg-slate-100 dark:bg-slate-800 shadow-lg rounded-lg p-4 sm:p-6">
      <!-- Sonarr -->
      <div class="mb-6 sm:mb-8">
        <div class="flex items-center gap-x-3 mb-2">
          <span class="inline-block w-12 h-12 sm:w-14 sm:h-14">
            <img src="{{ url_for('static', filename='logos/sonarr-light.png') }}" alt="Sonarr logo" class="w-full h-full object-contain dark:hidden">
            <img src="{{ url_for('static', filename='logos/sonarr-dark.png') }}" alt="Sonarr logo dark" class="w-full h-full object-contain hidden dark:inline">
          </span>
          <div>
            <span class="font-semibold text-xl sm:text-2xl text-slate-800 dark:text-slate-100">Sonarr</span>
            <span id="test-result-sonarr" class="ml-2 text-sm"></span> <!-- Updated ID -->
          </div>
        </div>
        <p class="text-slate-500 dark:text-slate-400 text-sm mb-3">Manages TV show downloads and keeps your TV library up to date automatically.</p>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1" for="sonarr_url">URL</label>
            <input type="text" id="sonarr_url" name="sonarr_url" value="{{ settings.sonarr_url }}" class="border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-slate-50 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
          </div>
          <div>
            <div class="flex items-center justify-between mb-1">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-200" for="sonarr_api_key">API Key</label>
              <a id="sonarr_key_link" href="{{ settings.sonarr_url.rstrip('/') if settings.sonarr_url else '#' }}/settings/general" target="_blank" class="text-sky-500 dark:text-sky-400 text-xs hover:underline">Get API Key</a>
            </div>
            <input type="text" id="sonarr_api_key" name="sonarr_api_key" value="{{ settings.sonarr_api_key }}" class="border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-slate-50 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
          </div>
        </div>
        <button type="button" data-service-name="sonarr" class="test-connection-btn bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 rounded-md shadow-sm mt-4 text-sm font-medium">Test Sonarr</button> <!-- Updated class, data attribute, and text -->
      </div>
      <hr class="my-6 border-slate-300 dark:border-slate-700">
      <!-- Radarr -->
      <div class="mb-6 sm:mb-8">
        <div class="flex items-center gap-x-3 mb-2">
          <span class="inline-block w-12 h-12 sm:w-14 sm:h-14">
            <img src="{{ url_for('static', filename='logos/radarr-light.png') }}" alt="Radarr logo" class="w-full h-full object-contain dark:hidden">
            <img src="{{ url_for('static', filename='logos/radarr-dark.png') }}" alt="Radarr logo dark" class="w-full h-full object-contain hidden dark:inline">
          </span>
          <div>
            <span class="font-semibold text-xl sm:text-2xl text-slate-800 dark:text-slate-100">Radarr</span>
            <span id="test-result-radarr" class="ml-2 text-sm"></span> <!-- Updated ID -->
          </div>
        </div>
        <p class="text-slate-500 dark:text-slate-400 text-sm mb-3">Manages movie downloads and organizes your movie library automatically.</p>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1" for="radarr_url">URL</label>
            <input type="text" id="radarr_url" name="radarr_url" value="{{ settings.radarr_url }}" class="border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-slate-50 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
          </div>
          <div>
            <div class="flex items-center justify-between mb-1">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-200" for="radarr_api_key">API Key</label>
              <a id="radarr_key_link" href="{{ settings.radarr_url.rstrip('/') if settings.radarr_url else '#' }}/settings/general" target="_blank" class="text-sky-500 dark:text-sky-400 text-xs hover:underline">Get API Key</a>
            </div>
            <input type="text" id="radarr_api_key" name="radarr_api_key" value="{{ settings.radarr_api_key }}" class="border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-slate-50 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
          </div>
        </div>
        <button type="button" data-service-name="radarr" class="test-connection-btn bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 rounded-md shadow-sm mt-4 text-sm font-medium">Test Radarr</button> <!-- Updated class, data attribute, and text -->
      </div>
      <hr class="my-6 border-slate-300 dark:border-slate-700">
      <!-- Bazarr -->
      <div>
        <div class="flex items-center gap-x-3 mb-2">
          <span class="inline-block w-12 h-12 sm:w-14 sm:h-14">
            <img src="{{ url_for('static', filename='logos/bazarr-light.png') }}" alt="Bazarr logo" class="w-full h-full object-contain dark:hidden">
            <img src="{{ url_for('static', filename='logos/bazarr-dark.png') }}" alt="Bazarr logo dark" class="w-full h-full object-contain hidden dark:inline">
          </span>
          <div>
            <span class="font-semibold text-xl sm:text-2xl text-slate-800 dark:text-slate-100">Bazarr</span>
            <span id="test-result-bazarr" class="ml-2 text-sm"></span> <!-- Updated ID -->
          </div>
        </div>
        <p class="text-slate-500 dark:text-slate-400 text-sm mb-3">Adds and manages subtitles for your movies and TV shows automatically.</p>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1" for="bazarr_url">URL</label>
            <input type="text" id="bazarr_url" name="bazarr_url" value="{{ settings.bazarr_url }}" class="border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-slate-50 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
          </div>
          <div>
            <div class="flex items-center justify-between mb-1">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-200" for="bazarr_api_key">API Key</label>
              <a id="bazarr_key_link" href="{{ settings.bazarr_url.rstrip('/') if settings.bazarr_url else '#' }}/settings" target="_blank" class="text-sky-500 dark:text-sky-400 text-xs hover:underline">Get API Key</a>
            </div>
            <input type="text" id="bazarr_api_key" name="bazarr_api_key" value="{{ settings.bazarr_api_key }}" class="border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-slate-50 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
          </div>
        </div>
        <button type="button" data-service-name="bazarr" class="test-connection-btn bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 rounded-md shadow-sm mt-4 text-sm font-medium">Test Bazarr</button> <!-- Updated class, data attribute, and text -->
      </div>
    </div>
  <button type="submit" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition-all duration-150 ease-in-out text-base font-semibold mt-8 flex items-center justify-center">Save Changes</button>
</form>

<!-- Library Sync Section -->
<div class="bg-slate-100 dark:bg-slate-800 shadow-lg rounded-lg p-4 sm:p-6 mt-8 max-w-2xl mx-auto">
  <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-100 mb-3">Library Synchronization</h3>
  <p class="text-slate-500 dark:text-slate-400 text-sm mb-4">
    Manually trigger a synchronization of your Sonarr or Radarr libraries with the local database.
    This process might take some time depending on the size of your libraries.
  </p>
  <div class="space-y-4 sm:space-y-0 sm:flex sm:space-x-4">
    <form method="POST" action="{{ url_for('main.admin_sync_sonarr') }}" class="flex-1">
      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all duration-150 ease-in-out text-base font-semibold flex items-center justify-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2M9 15h4.581"></path></svg>
        Sync Sonarr Library
      </button>
    </form>
    <form method="POST" action="{{ url_for('main.admin_sync_radarr') }}" class="flex-1">
      <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition-all duration-150 ease-in-out text-base font-semibold flex items-center justify-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2M9 15h4.581"></path></svg>
        Sync Radarr Library
      </button>
    </form>
  </div>
  <p class="text-xs text-slate-400 dark:text-slate-500 mt-3">
    Note: The page will reload after the sync process is initiated and completed. Feedback messages will be displayed at the top.
  </p>
</div>
  

<div class="bg-amber-50 dark:bg-amber-900/30 border-l-4 border-amber-400 dark:border-amber-500 p-4 sm:p-6 mt-10 rounded-r-lg shadow-md max-w-2xl mx-auto">
  <div class="flex items-center mb-3">
    <svg class="w-6 h-6 text-amber-500 dark:text-amber-400 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 20h.01M21.75 12a9.75 9.75 0 11-19.5 0 9.75 9.75 0 0119.5 0z"/></svg> Info
    <h3 class="font-semibold text-xl text-amber-800 dark:text-amber-200">Plex Webhook Integration</h3>
  </div>
  <p class="text-amber-700 dark:text-amber-300 mb-4 text-sm">To enable Plex events in this app, you need to add a webhook in your Plex server settings. Follow these steps:</p>
  <ol class="list-decimal list-inside mb-4 text-amber-800 dark:text-amber-200 space-y-1 text-sm">
    <li>Open your <span class="font-semibold">Plex Web App</span> and sign in as an admin.</li>
    <li>Click the <span class="font-semibold">Settings</span> (wrench icon) in the top right.</li>
    <li>In the left sidebar, under <span class="font-semibold">Settings</span>, click <span class="font-semibold">Webhooks</span> (you may need to expand <span class="font-semibold">Advanced</span> to find it).</li>
    <li>Click <span class="font-semibold">Add Webhook</span>.</li>
    <li>Paste the following URL into the webhook URL field:</li>
  </ol>
  <div class="bg-slate-100 dark:bg-slate-800 border border-amber-300 dark:border-amber-600 rounded px-4 py-3 mb-4 text-sm font-mono text-slate-800 dark:text-slate-100 select-all break-all">
    {{ site_url }}/plex/webhook
  </div>
  <p class="text-amber-700 dark:text-amber-300 text-sm">Click <span class="font-semibold">Save</span>. Plex will now send event notifications to this app.</p>
  <p class="text-xs text-amber-600 dark:text-amber-400 mt-3">You can test the webhook by playing or pausing media in Plex and checking this app for activity.</p>
</div>

<script src="{{ url_for('static', filename='admin_settings.js') }}" defer></script>

<script>
// New JavaScript for test-connection-btn
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.test-connection-btn').forEach(button => {
        button.addEventListener('click', function() {
            const serviceName = this.dataset.serviceName;
            const resultSpan = document.getElementById('test-result-' + serviceName);

            if (!resultSpan) {
                console.error('Result span not found for service:', serviceName);
                return;
            }

            resultSpan.textContent = 'Testing...';
            resultSpan.style.color = 'inherit'; // Reset color
            this.disabled = true;

            fetch('/admin/api/services/test/' + serviceName, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // TODO: Add CSRF token header if application uses Flask-WTF or similar
                    // Example: 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                }
            })
            .then(response => {
                if (!response.ok) {
                    // Try to parse error from response body for more specific feedback
                    return response.json().then(errData => {
                        throw new Error(errData.error || `HTTP error ${response.status}`);
                    }).catch(() => {
                        // Fallback if response is not JSON or no specific error message
                        throw new Error(`HTTP error ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'online') {
                    resultSpan.textContent = 'Success! Status: ' + data.status + (data.version && data.version !== 'N/A' ? ', Version: ' + data.version : '');
                    resultSpan.style.color = 'green';
                } else {
                    resultSpan.textContent = 'Failed. Status: ' + data.status + (data.details && data.details.error ? ' Error: ' + data.details.error : '');
                    resultSpan.style.color = 'red';
                }
            })
            .catch(error => {
                console.error('Error testing service ' + serviceName + ':', error);
                resultSpan.textContent = 'Error: ' + error.message;
                resultSpan.style.color = 'red';
            })
            .finally(() => {
                this.disabled = false;
            });
        });
    });
});
</script>
{% endblock %}
